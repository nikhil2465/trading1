<!DOCTYPE html>
<html>
<head>
    <title>Tools - Bollinger Band & RSI Scanner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #e3f0ff; min-height: 100vh; }
        .footer { margin-top: 40px; padding: 20px 0; background: #f8f9fa; text-align: center; color: #888; font-size: 0.95rem; }
        .macro-box { background: #fff; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); padding: 1.5rem; margin-bottom: 2rem; }
        .copy-btn { float: right; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 6px; font-size: 0.95rem; }
    </style>
    <script>
        function copyMacro() {
            var macroText = document.getElementById('macroCode').innerText;
            navigator.clipboard.writeText(macroText);
            alert('Macro copied to clipboard!');
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Bollinger Band & RSI Scanner</a>
            <div>
                <a class="btn btn-link" href="/home">Home</a>
                <a class="btn btn-link" href="/tools">Tools</a>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card p-4 mb-4">
                    <h2>Excel Macro Tool</h2>
                    <p>
                        Use the macro below to process your Excel data as described. You can copy the macro and use it in your Excel VBA editor.
                        <button class="btn btn-outline-primary btn-sm copy-btn" onclick="copyMacro()">Copy Macro</button>
                    </p>
                    <pre id="macroCode">Sub CA_Dayanand_Bongale_Mobile_6362985767()
    Rows("1:1").Delete Shift:=xlUp
    Columns("A:A").Delete Shift:=xlToLeft
    Columns("D:J").Delete Shift:=xlToLeft
    Columns("E:K").Delete Shift:=xlToLeft

    Dim rng As Range
    Dim col As Range

    Set rng = Union(Range("A:A"), Range("B:B"), Range("C:C"), Range("E:E"), Range("F:F"), Range("G:G"))
    Set rng = ActiveSheet.UsedRange
    rng.NumberFormat = "0.00"
    rng.Replace What:=",", Replacement:="", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False

    For Each col In rng.Columns
        col.FormatConditions.AddTop10
        With col.FormatConditions(1)
            .SetFirstPriority
            .TopBottom = xlTop10Top
            .Rank = 3
            .Percent = False
        End With
        With col.FormatConditions(1).Interior
            .PatternColorIndex = xlAutomatic
            .Color = 13551615
            .TintAndShade = 0
        End With
        col.FormatConditions(1).StopIfTrue = False
    Next col

    Range("A:A").Copy
    Range("A:A").PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Range("B:B").Copy
    Range("B:B").PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Range("C:C").Copy
    Range("C:C").PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Range("E:E").Copy
    Range("E:E").PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Range("F:F").Copy
    Range("F:F").PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Range("G:G").Copy
    Range("G:G").PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Range("H1").Value = "PCR OI"
    Range("I1").Value = "PCR Volume"
    Range("J1").Value = "PCR Change in OI"
    Range("M1").Value = "CPR OI"
    Range("N1").Value = "CPR Vol"
    Range("O1").Value = "CPR Sum"
    Range("P1").Value = "Resistance"

    Range("H2").FormulaR1C1 = "=RC[-1]/RC[-7]"
    Range("I2").FormulaR1C1 = "=RC[-4]/RC[-6]"
    Range("J2").FormulaR1C1 = "=RC[-4]/RC[-8]"
    Range("M2").FormulaR1C1 = "=RC[-12]/RC[-6]"
    Range("N2").FormulaR1C1 = "=RC[-11]/RC[-9]"
    Range("O2").FormulaR1C1 = "=RC[-1]+RC[-2]"

    Dim lastRow As Long
    lastRow = Range("A" & Rows.Count).End(xlUp).Row

    Range("H2").AutoFill Destination:=Range("H2:H" & lastRow)
    Range("I2").AutoFill Destination:=Range("I2:I" & lastRow)
    Range("J2").AutoFill Destination:=Range("J2:J" & lastRow)
    Range("M2").AutoFill Destination:=Range("M2:M" & lastRow)
    Range("N2").AutoFill Destination:=Range("N2:N" & lastRow)
    Range("O2").AutoFill Destination:=Range("O2:O" & lastRow)

    Range("H2:J" & lastRow).Copy
    Range("H2:J" & lastRow).PasteSpecial Paste:=xlPasteFormats
    Application.CutCopyMode = False

    Columns("B:B").EntireColumn.AutoFit
    Columns("C:C").ColumnWidth = 8.55
    Columns("F:F").EntireColumn.AutoFit
    Columns("I:I").EntireColumn.AutoFit
    Columns("J:J").EntireColumn.AutoFit
    Columns("P:P").EntireColumn.AutoFit

    With ActiveWindow
        .SplitColumn = 0
        .SplitRow = 1
    End With
    ActiveWindow.FreezePanes = True

    Range("H2:J" & lastRow).NumberFormat = "0.00"

    On Error Resume Next
    Range("A:O").SpecialCells(xlCellTypeFormulas, xlErrors).Value = "illiquid"
    On Error GoTo 0

    Cells.VerticalAlignment = xlCenter
    Cells.HorizontalAlignment = xlCenter

    Dim rngH As Range
    Dim rngCell As Range
    Set rngH = Range("H2:H" & lastRow)
    For Each rngCell In rngH
        If rngCell.Value > 1 Then
            rngCell.Interior.Color = RGB(0, 255, 0)
        End If
    Next rngCell

    Dim analysisColumn As Range
    Dim i As Long
    Set analysisColumn = Range("K2:K" & lastRow)
    For i = 2 To lastRow
        analysisColumn.Cells(i - 1).Value = WorksheetFunction.Sum(Range("H" & i & ":I" & i))
    Next i

    Range("K1").Value = "PCR Sum"

    Dim supportColumn As Range
    Set supportColumn = Range("L2:L" & lastRow)
    Dim rowIndex As Long
    For rowIndex = 2 To lastRow
        Dim valueK As Double
        valueK = analysisColumn.Cells(rowIndex - 1).Value
        If valueK > 8 Then
            supportColumn.Cells(rowIndex - 1).Value = "Very Good Support"
        ElseIf valueK > 5 Then
            supportColumn.Cells(rowIndex - 1).Value = "Good Support"
        ElseIf valueK > 3 Then
            supportColumn.Cells(rowIndex - 1).Value = "Support"
        End If
    Next rowIndex

    For rowIndex = 2 To lastRow
        Dim valueO As Variant
        valueO = Range("O" & rowIndex).Value
        If IsNumeric(valueO) Then
            If valueO > 6 Then
                Range("P" & rowIndex).Value = "Very Good Resistance"
            ElseIf valueO > 3 Then
                Range("P" & rowIndex).Value = "Resistance"
            Else
                Range("P" & rowIndex).Value = ""
            End If
        End If
    Next rowIndex

    Range("L1").Value = "PCR Support"
    supportColumn.EntireColumn.AutoFit

    Dim rngI As Range
    Set rngI = Range("I2:I" & lastRow)
    For Each rngCell In rngI
        If rngCell.Value > 1 And UCase(rngCell.Value) <> "ILLIQUID" Then
            rngCell.Interior.Color = RGB(0, 255, 0)
        End If
    Next rngCell

    Columns("B:B").Hidden = True
    Columns("F:F").Hidden = True
    Columns("J:J").Hidden = True
End Sub
</pre>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h5>How to Use the Macro:</h5>
                            <ol>
                                <li>Copy the macro above using the "Copy Macro" button.</li>
                                <li>Open Excel and press Alt + F11 to open the VBA editor.</li>
                                <li>Insert a new module and paste the code.</li>
                                <li>Run the macro on your data.</li>
                                <li>Save the Excel file after running the macro.</li>
                            </ol>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Process After Macro</h5>
                                    <p class="card-text">Upload your Excel file after running the macro to get only the required columns:</p>
                                    <form action="/process_after_macro" method="post" enctype="multipart/form-data">
                                        <div class="input-group mb-3">
                                            <input type="file" class="form-control" name="macro_file" accept=".xls,.xlsx" required>
                                            <button type="submit" class="btn btn-primary">Process File</button>
                                        </div>
                                        <small class="text-muted">This will keep only the Chanakya Support and Chanakya Resistance columns.</small>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    </ol>
                </div>

                <div class="card p-4 mb-4">
                    <h2>Try It Yourself</h2>
                    <p>Upload your Excel, CSV, or plain text file here to share or download it. (Macro processing must be done in Excel.)</p>
                    
                    <form method="POST" enctype="multipart/form-data" action="/tools">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="shareFile" name="share_file" accept=".xlsx,.xls,.csv,.txt">
                            <div class="form-text">Note: Macro processing must be done in Excel. This upload/download is for sharing files only. TXT files are also supported for upload/download.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload & Download</button>
                    </form>
                </div>

                <div class="card p-4 mb-4">
                    <h2>Get Data from NSE Option Chain</h2>
                    <p>
                        You can access the official <b>NSE Option Chain</b> and download all kinds of option data directly from their website.
                    </p>
                    <ol>
                        <li>
                            <a href="https://www.nseindia.com/option-chain" target="_blank" class="btn btn-outline-primary mb-2">
                                Go to NSE Option Chain
                            </a>
                        </li>
                        <li>
                            On the NSE page, select your desired symbol and expiry, then click the <b>Download CSV</b> button to get the data.
                        </li>
                        <li>
                            Upload the downloaded CSV file here (or convert to Excel if needed), then use the macro tool above to process and analyze your data.
                        </li>
                    </ol>
                    <small class="text-muted">Note: Downloaded CSV files from NSE can be uploaded above and processed using the macro in Excel.</small>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        &copy; 2024 Bollinger Band & RSI Scanner. Powered by Flask & Chartink.
    </div>
</body>
</html>